<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>微服务 | Acting个人博客</title><meta name="keywords" content="java"><meta name="author" content="Acting"><meta name="copyright" content="Acting"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="微服务"><meta name="application-name" content="微服务"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="微服务"><meta property="og:url" content="http://example.com/2023/12/30/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84/index.html"><meta property="og:site_name" content="Acting个人博客"><meta property="og:description" content="微服务 单体架构  将所有功能几中在一个项目中开发 打包成一个包部署  架构简单 部署成本低  团队协作成本高  系统发布效率低  大型项目编译需要几十分钟 耗时长  系统可用性差  适合开发功能简单 规模较小的项目    微服务  把单体架构中的功能模块拆分成多个独立的项目 粒度小 团队自治 服务"><meta property="og:locale" content="en"><meta property="og:image" content="http://example.com/images/touxiang.jpg"><meta property="article:author" content="Acting"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http://example.com/images/touxiang.jpg"><meta name="description" content="微服务 单体架构  将所有功能几中在一个项目中开发 打包成一个包部署  架构简单 部署成本低  团队协作成本高  系统发布效率低  大型项目编译需要几十分钟 耗时长  系统可用性差  适合开发功能简单 规模较小的项目    微服务  把单体架构中的功能模块拆分成多个独立的项目 粒度小 团队自治 服务"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://example.com/2023/12/30/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84/"><link rel="preconnect" href="//cdn.cbd.int"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: {"enable":true,"img":"https://upload-bbs.miyoushe.com/upload/2023/09/03/125766904/ee23df8517f3c3e3efc4145658269c06_5714860933110284659.png"},
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: undefined,
  greetingBox: undefined,
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: undefined,
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: 'days',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"Author: Acting","link":"Link: ","source":"Source: Acting个人博客","info":"Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source.","copySuccess":"Copy success, copy and reprint please mark the address of this article"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"Traditional Chinese Activated Manually","cht_to_chs":"Simplified Chinese Activated Manually","day_to_night":"Dark Mode Activated Manually","night_to_day":"Light Mode Activated Manually","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'Acting个人博客',
  title: '微服务',
  postAI: '',
  pageFillDescription: '微服务, SpringCloud, 服务治理, Nacos, OpenFegin, 连接池, 最佳实践, 日志输出, 网关, 网关路由, 自定义过滤器, 用户信息的传递, 网关传递到微服务, 微服务之间传递用户信息, 配置管理, nacos 配置管理服务, 配置共享, 配置热更新, 动态路由, 微服务保护和分布式事务, 雪崩问题, Sentinel, 分布式事务, Seata, RabbitMQ, 同步调用, 异步调用, MQ技术选型, 操作, Work Queues, 交换机, 声明队列交换机, RabbitMQ高级, 发送者可靠性, MQ可靠性, LazyQueue 惰性队列, 消费者可靠性, 消费者确认机制, 消费者失败重试机制, 业务幂等性, 唯一消息id, 给每个消息都设置一个唯一id liyongid区分是否是重复消息, 业务判断, 结合业务逻辑 基于业务本身做判断, 延迟消息, 死信交换机, 延迟消息插件, 取消超时订单, Elasticsearch微服务单体架构将所有功能几中在一个项目中开发打包成一个包部署架构简单部署成本低团队协作成本高系统发布效率低大型项目编译需要几十分钟耗时长系统可用性差适合开发功能简单规模较小的项目微服务把单体架构中的功能模块拆分成多个独立的项目粒度小团队自治服务自治每个服务对应一个服务器一个数据库集成了各种微服务功能组件并基于实现了组件的自动装配从而提供了良好的开箱即用体验拆分目标高内聚每个微服务的职责尽量单一包含业务相互关联度高完整度高低耦合每个微服务功能相对独立尽量减少对其他微服务的依赖工程结构独立聚合一个下好几个远程调用声明的能够自动注入取消使用注解使用服务治理服务提供者暴露服务接口供其他服务调用服务消费者调用其他服务提供的接口注册中心记录并监控微服务各实例状态推送服务变更信息服务提供者的心跳机制提供者会在启动时注册自己信息到注册中心消费者可以从注册中心订阅和拉取服务信息提供者有多个实例时消费者可以通过负载均衡算法从多个实例中选择一个国内企业占比最多的注册中心组件目前已加入到配置数据表部署引入依赖配置地址服务消费者调用拉取实例列表挑选一个实例负载均衡获取实例的声明式的客户端基于常见的注解帮我们优雅的实现请求的发送引入依赖和开启注解编写连接池对请求做了伪装底层发起请求依赖于其他框架默认为不支持连接池连接池允许客户端重用连接来发送多个请求而不是为每个请求都创建一个新的连接这不仅可以减少连接的建立和销毁的开销还可以减少由于握手和握手导致的延整合的步骤引入依赖配置文件开启连接池功能最佳实践微服务课程方法一方法二日志输出声明类型为的四个级别在或者注解上声明的位置网关网络的关口负责请求的路由转发身份校验基于响应式编程无需调优即可获得优异性能网关路由创建新的模块引入网关依赖编写启动类配置路由规则路由过滤器自定义过滤器路由过滤器作用于任意指定的路由默认不生效要配置到路由后生效全局过滤的用户信息的传递网关传递到微服务首先在网关的登录校验过滤器中把获取的用户写入请求头拦截器里获取到用户信息然后保存到里微服务之间传递用户信息提供了一个拦截器的接口提供允许对请求头进行操作配置管理微服务重复配置过多维护成本高业务配置经常变动每次修改都要重启服务网关路由配置写死如果变更要重启网关配置管理服务配置共享添加共享配置到包括日志基于拉取共享配置代替微服务的本地配置添加依赖自动配置配置文件新建文件配置热更新当修改配置文件中的配置时微服务无序重启即可使配置生效如时长验证次数等等需要修改中要有一个与微服务名有关的配置文件微服务中要以特定的方式读取需要热更新的配置属性推荐使用第一种添加注解动态路由微服务保护和分布式事务雪崩问题微服务调用链路中的某个服务故障引起整个链路中的所有微服务都不用请求限流限制微服务的请求的并发量即线程隔离限定每个业务能使用的线程数量而将故障业务隔离避免一个业务将整个服务阻塞调节并发线程数个并发线程如果单线程为那么线程的为服务熔断断路器统计请求的异常比例或慢调用比例如果超出与之则会熔断该业务拦截该接口的请求所有请求快速失败全都走逻辑将作为的簇点资源配置文件开启的配置有两种方式无法对远程调用的异常做处理可以对远程调用的异常做处理自定义失败处理定义逻辑让业务失败时不再抛出异常而是返回默认数据或友好提示阿里巴巴开源的一款微服务流量控制组件分布式事务阿里巴巴和蚂蚁金服共同设计的分布式事务的解决方案事务协调者维护全局和分支事务的状态协调全局事务提交或回滚事务管理器定义全局事务的范围开启全局事务提交或回滚全局事务资源管理器管理分支事务与交谈以注册分支事务和报告分支事务的状态高性能异步通讯组件同步调用时效性强等待到结果才返回扩展性差性能下降级联失败异步调用解除耦合扩展性强无需等待性能好故障隔离下游服务故障不影响上游业务缓存消息流量削峰填补不会得到结果时效性差业务安全依赖的可靠性技术选型虚拟主机数据隔离操作基于操作引入依赖配置文件添加配置注入调用发消息添加注释传入监听队列名称方法参数存储接收的消息自动进行消息与参数对象的转换任务模型让多个消费者绑定到一个队列共同消费队列中的消息消费者消息推送限制默认情况下会将消息依次轮询投递给绑定在队列上的消费者但是这并没有考虑消费者是否已经处理完消息可能会出现消费堆积所以修改配置文件设置为确保统一时刻最多投递给消费者条消息模型的使用多个消费者绑定到一个队列可以加快消息处理速度同一条消息只会被一个消费者处理通过设置来控制消费者预取的消息数量处理完一条在处理下一条实现能者多劳交换机接收发送的消息将消息按照规则路由到与之绑定的队列广播将消息发送给所有队列定向将收到消息按照规则路由到指定的每个斗鱼设置一个发布者发送消息时指定消息的将消息路由到与消息一致的队列话题基于做消息路由但是通常是多个单词的组合并且是以分隔与指定可以使用通配符代指个或多个单词代指一个单词声明队列交换机提供了几个类同于声明队列交换机及其绑定关系声明队列声明交换机声明交换机和队列的绑定关系使用工厂类构建案例改造余额支付功能不再同步调用支付服务的接口而是采用异步通知交易服务更新订单状态一些边缘业务适合使用处理更新订单状态短信通知用户增加用户积分高级消息可靠性问题发送者可靠性发送者重连由于网络波动可能会出现发送者发送失败的情况通过配置可以开启连接失败后的重连机制但是重连机制是阻塞式的重试多次重连等待过程中当前线程是被阻塞的影响业务性能对于有业务性能需求建议禁用重试机制当然也可以考虑使用异步线程来执行发送消息的代码发送者确认机制提供了和两种确认机制开启后当发送者发送消息给后会返回结果给发送者消息投递到但是路由失败返回临时消息投递到并且入队成功返回持久消息投递到并且入队完成持久化返回其他情况返回告知投递失败开启机制三种模式关闭同步阻塞等待回执异步回调方式返回回执消息可靠性默认情况会把消息存储在内存降低消息收发的延迟一旦宕机内存中的消息会丢失并且内存空间有限当消费者故障或者处理过慢会导致消息挤压开启数据持久化会存入磁盘但是会导致性能下降无法应对高并发惰性队列接收消息后直接存入磁盘不再存入内存消费者要消费时才会从磁盘中读取并加载到内存可以提前缓存部分消息到内存最多条在版本后所有队列都是模式无法更改消费者可靠性消费者确认机制当消费者处理消息结束后向发送一个回执告知自己消息处理的状态成功处理消息从队列中删除消息消息处理失败再次投递消息消息处理失败并拒绝该消息从队列中删除该消息实现了消息确认机制配置文件开启不处理消息投递之后立刻消息从中删除手动模式需要自己在业务代码中调用发送或者存在业务入侵但灵活自动模式利用对消息处理逻辑做了环绕增强当业务正常时自动返回业务异常自定返回消息处理或校验异常返回消费者失败重试机制配置文件开启重试机制如果重试次数达到上限则需要接口来处理包含三种不同的实现重试次数耗尽后直接丢弃消息默认该方法重试次数耗尽后返回消息重新入队重试后将失败的消息投递到指定的交换机业务幂等性在程序开发中指同一个业务执行一次或多次对业务的状态的影响是一致的唯一消息给每个消息都设置一个唯一区分是否是重复消息每一条消息都生成一个唯一的与消息一起投递给消费者消费者接收后处理自己的业务业务处理成功后将消息存入数据库下次收到同样的消息数据库查询是否存在业务判断结合业务逻辑基于业务本身做判断面试题如何确保支付服务和交易服务之间的订单状态一致性首先支付服务会在用户支付成功后利用通知交易服务完成订单状态同步其次为了保证消息可靠性我们采用生产者确认机制消费者确认消费者失败重试等策略确保消息投递和处理的可靠性同时也开启了的持久化避免因为服务宕机导致消息丢失左后我们还在交易服务更新订单状态时做了业务幂等判断避免因为重复消息导致订单状态异常延迟消息在网络异常等特殊情况发送者发送消息指定一个时间消费者不会立刻收到消息而是在指定时间后才收到消息死信交换机死信消费者使用或者声明消费失败并且消费的参数设置为消息是一个过期消息达到了队列或消息本身设置的过期时间超时无人消费要投递的队列消息堆积满了最早的消息可能成为死信如果队列通过属性制定了一个交换机那么该队列中的死信就会投递到这个交换机中这个交换机成为死信交换机延迟消息插件将普通交换机改为支持延迟消息功能的交换机当消息投递到交换机可以暂存一定时间到期后再投递到队列取消超时订单',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-09-15 10:59:25',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://npm.elemecdn.com/anzhiyu-blog-static@1.0.4/img/avatar.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><a id="site-name" href="/" accesskey="h"><div class="title">Acting个人博客</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a><div id="he-plugin-simple"></div><script>var WIDGET = {
  "CONFIG": {
    "modules": "0124",
    "background": "2",
    "tmpColor": "FFFFFF",
    "tmpSize": "16",
    "cityColor": "FFFFFF",
    "citySize": "16",
    "aqiColor": "E8D87B",
    "aqiSize": "16",
    "weatherIconSize": "24",
    "alertIconSize": "18",
    "padding": "10px 10px 10px 10px",
    "shadow": "0",
    "language": "auto",
    "borderRadius": "20",
    "fixed": "true",
    "vertical": "top",
    "horizontal": "left",
    "left": "20",
    "top": "7.1",
    "key": "df245676fb434a0691ead1c63341cd94"
  }
}
</script><link rel="stylesheet" href="https://widget.qweather.net/simple/static/css/he-simple.css?v=1.4.0"/><script src="https://widget.qweather.net/simple/static/js/he-simple.js?v=1.4.0"></script></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> Newest Comments</span></div><div class="aside-list"><span>loading...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/Linux/" style="font-size: 1.05rem;">Linux<sup>1</sup></a><a href="/tags/TCP/" style="font-size: 1.05rem;">TCP<sup>1</sup></a><a href="/tags/UDP/" style="font-size: 1.05rem;">UDP<sup>1</sup></a><a href="/tags/docker/" style="font-size: 1.05rem;">docker<sup>1</sup></a><a href="/tags/git/" style="font-size: 1.05rem;">git<sup>1</sup></a><a href="/tags/java/" style="font-size: 1.05rem;">java<sup>6</sup></a><a href="/tags/mysql/" style="font-size: 1.05rem;">mysql<sup>3</sup></a><a href="/tags/springMVC/" style="font-size: 1.05rem;">springMVC<sup>1</sup></a><a href="/tags/springboot/" style="font-size: 1.05rem;">springboot<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>Archives</span></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/12/"><span class="card-archive-list-date">December 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="article-meta tags"><a class="article-meta__tags" href="/tags/java/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>java</span></a></span></div></div><h1 class="post-title" itemprop="name headline">微服务</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2023-12-30T08:34:20.000Z" title="Created 2023-12-30 16:34:20">2023-12-30</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-09-15T02:59:25.980Z" title="Updated 2024-09-15 10:59:25">2024-09-15</time></span></div><div class="meta-secondline"><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为长沙"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>长沙</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src=""></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://example.com/2023/12/30/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84/"><header><a href="/tags/java/" tabindex="-1" itemprop="url">java</a><h1 id="CrawlerTitle" itemprop="name headline">微服务</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">Acting</span><time itemprop="dateCreated datePublished" datetime="2023-12-30T08:34:20.000Z" title="Created 2023-12-30 16:34:20">2023-12-30</time><time itemprop="dateCreated datePublished" datetime="2024-09-15T02:59:25.980Z" title="Updated 2024-09-15 10:59:25">2024-09-15</time></header><h1 id="微服务"><a href="#微服务" class="headerlink" title="微服务"></a>微服务</h1><ul>
<li><p>单体架构</p>
<ul>
<li><p>将所有功能几中在一个项目中开发 打包成一个包部署</p>
</li>
<li><p>架构简单 部署成本低</p>
</li>
<li><p>团队协作成本高</p>
</li>
<li><p>系统发布效率低  大型项目编译需要几十分钟 耗时长</p>
</li>
<li><p>系统可用性差</p>
</li>
<li><p><strong>适合开发功能简单 规模较小的项目</strong></p>
</li>
</ul>
</li>
<li><p>微服务</p>
<ul>
<li>把单体架构中的功能模块拆分成多个独立的项目</li>
<li>粒度小</li>
<li>团队自治</li>
<li>服务自治  每个服务对应 一个web服务器 一个数据库</li>
</ul>
</li>
</ul>
<h2 id="SpringCloud"><a href="#SpringCloud" class="headerlink" title="SpringCloud"></a>SpringCloud</h2><p>集成了各种微服务功能组件 并基于SpringBoot实现了组件的自动装配 从而提供了良好的开箱即用体验</p>
<p>拆分目标 <strong>高内聚</strong> 每个微服务的职责尽量单一 包含业务相互关联度高 完整度高  <strong>低耦合</strong> 每个微服务功能相对独立 尽量减少对其他微服务的依赖</p>
<p>工程结构：</p>
<ul>
<li>独立project</li>
<li>maven聚合   一个project下好几个module</li>
</ul>
<p>远程调用</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\86186\AppData\Roaming\Typora\typora-user-images\image-20240727113255997.png" alt="image-20240727113255997"></p>
<p><code>@RequiredArgsContructor</code> 声明 final 的bean 能够自动注入 取消使用@Autowired注解使用</p>
<h2 id="服务治理"><a href="#服务治理" class="headerlink" title="服务治理"></a>服务治理</h2><p><strong>服务提供者</strong> 暴露服务接口 供其他服务调用</p>
<p><strong>服务消费者</strong> 调用其他服务提供的接口</p>
<p><strong>注册中心</strong> 记录并监控微服务各实例状态 推送服务变更信息（服务提供者的心跳机制）</p>
<p>提供者会在启动时注册自己信息到注册中心 消费者可以从注册中心订阅和拉取服务信息</p>
<p>提供者有多个实例时 消费者可以通过负载均衡算法 从多个实例中选择一个</p>
<h3 id="Nacos"><a href="#Nacos" class="headerlink" title="Nacos"></a>Nacos</h3><p>国内企业占比最多的注册中心组件 目前已加入到SpringCloudAlibaba</p>
<ol>
<li>配置Nacos数据表</li>
<li>doker部署</li>
<li>引入依赖</li>
<li>配置yml nacos地址</li>
<li>服务消费者： 调用 DiscoveryClient API <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\86186\AppData\Roaming\Typora\typora-user-images\image-20240727123451360.png" alt="image-20240727123451360"></li>
</ol>
<p>拉取实例列表 挑选一个实例 负载均衡 获取实例的ip</p>
<h3 id="OpenFegin"><a href="#OpenFegin" class="headerlink" title="OpenFegin"></a>OpenFegin</h3><p>声明式的http客户端  基于SpringMvC常见的注解 帮我们优雅的实现http请求的发送 </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\86186\AppData\Roaming\Typora\typora-user-images\image-20240727124448074.png" alt="image-20240727124448074"></p>
<ol>
<li>引入依赖 openfegin和loadbalance </li>
<li>开启注解</li>
<li>编写feignClient</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\86186\AppData\Roaming\Typora\typora-user-images\image-20240727124914944.png" alt="image-20240727124914944"></p>
<h4 id="连接池"><a href="#连接池" class="headerlink" title="连接池"></a>连接池</h4><p>openfeign对http请求做了伪装 底层发起http请求依赖于其他框架 默认为HttpURLConnection 不支持连接池 </p>
<p><em>HTTP连接池允许客户端重用TCP连接来发送多个HTTP请求，而不是为每个请求都创建一个新的TCP连接。这不仅可以减少TCP连接的建立和销毁的开销，还可以减少由于TCP握手和SSL&#x2F;TLS握手导致的延</em></p>
<p>openfegin整合okhttp的步骤</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\86186\AppData\Roaming\Typora\typora-user-images\image-20240727153309479.png" alt="image-20240727153309479" style="zoom:80%;" />

<ul>
<li>引入依赖</li>
<li>配置文件开启连接池功能</li>
</ul>
<h4 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h4><p>微服务课程P52  ！！！！</p>
<p>方法一 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\86186\AppData\Roaming\Typora\typora-user-images\image-20240727155951160.png" alt="image-20240727155951160" style="zoom:30%;" /></p>
<p>方法二<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\86186\AppData\Roaming\Typora\typora-user-images\image-20240727160037147.png" alt="image-20240727160037147" style="zoom:30%;" /></p>
<h4 id="日志输出"><a href="#日志输出" class="headerlink" title="日志输出"></a>日志输出</h4><p>声明类型为 Logger.Level的Bean</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultFeignConfig</span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Logger.Level <span class="title function_">feignLogLevel</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Logger.level.FUll; <span class="comment">//四个级别</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在@FeignClient或者@EnableFeignClient注解上声明 bean的位置</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">(configuration = DefaultFeignConfig.class)</span><br></pre></td></tr></table></figure>

<h2 id="网关"><a href="#网关" class="headerlink" title="网关"></a>网关</h2><p>网络的关口 负责请求的<strong>路由 转发 身份校验</strong></p>
<p><strong>SpringCloudGateway</strong></p>
<p>基于webFlux响应式编程</p>
<p>无需调优即可获得优异性能</p>
<h3 id="网关路由"><a href="#网关路由" class="headerlink" title="网关路由"></a>网关路由</h3><ol>
<li>创建新的模块</li>
<li>引入网关依赖</li>
<li>编写启动类</li>
<li>配置路由规则</li>
</ol>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\86186\AppData\Roaming\Typora\typora-user-images\image-20240727173046433.png" alt="image-20240727173046433" style="zoom:50%;" />

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\86186\AppData\Roaming\Typora\typora-user-images\image-20240727181510339.png" alt="image-20240727181510339"></p>
<p>路由过滤器</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\86186\AppData\Roaming\Typora\typora-user-images\image-20240727182410802.png" alt="image-20240727182410802"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\86186\AppData\Roaming\Typora\typora-user-images\image-20240727183709992.png" alt="image-20240727183709992"></p>
<h3 id="自定义过滤器"><a href="#自定义过滤器" class="headerlink" title="自定义过滤器"></a>自定义过滤器</h3><ul>
<li>GatewayFilter 路由过滤器 作用于任意指定的路由 默认不生效 要配置到路由后生效</li>
<li>GlobalFilter 全局过滤的</li>
</ul>
<h3 id="用户信息的传递"><a href="#用户信息的传递" class="headerlink" title="用户信息的传递"></a>用户信息的传递</h3><h4 id="网关传递到微服务"><a href="#网关传递到微服务" class="headerlink" title="网关传递到微服务"></a>网关传递到微服务</h4><p>首先在网关的登录校验过滤器中 把获取的用户写入请求头</p>
<p>拦截器里 获取到用户信息 然后保存到threadLocal里</p>
<h4 id="微服务之间传递用户信息"><a href="#微服务之间传递用户信息" class="headerlink" title="微服务之间传递用户信息"></a>微服务之间传递用户信息</h4><p>openfeign提供了一个拦截器的接口 RequestInterceptor</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\86186\AppData\Roaming\Typora\typora-user-images\image-20240729154450791.png" alt="image-20240729154450791"></p>
<p>提供header API 允许对请求头进行操作</p>
<h2 id="配置管理"><a href="#配置管理" class="headerlink" title="配置管理"></a>配置管理</h2><p>微服务重复配置过多 维护成本高  业务配置经常变动 每次修改都要重启服务  网关路由配置写死 如果变更要重启网关  </p>
<h3 id="nacos-配置管理服务"><a href="#nacos-配置管理服务" class="headerlink" title="nacos 配置管理服务"></a>nacos 配置管理服务</h3><h4 id="配置共享"><a href="#配置共享" class="headerlink" title="配置共享"></a>配置共享</h4><ol>
<li>添加共享配置到nacos 包括jdbc mp 日志 swagger openfeign</li>
<li>基于nacosconfig拉取共享配置代替微服务的本地配置<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\86186\AppData\Roaming\Typora\typora-user-images\image-20240729182954077.png" alt="image-20240729182954077" style="zoom:50%;" /></li>
</ol>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\86186\AppData\Roaming\Typora\typora-user-images\image-20240729183013126.png" alt="image-20240729183013126" style="zoom:50%;" />



<ol start="3">
<li><p>添加依赖 自动配置bootstrap配置文件   </p>
</li>
<li><p>新建yaml文件 <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\86186\AppData\Roaming\Typora\typora-user-images\image-20240729183140971.png" alt="image-20240729183140971"></p>
</li>
</ol>
<h4 id="配置热更新"><a href="#配置热更新" class="headerlink" title="配置热更新"></a>配置热更新</h4><p>当修改配置文件中的配置时 微服务无序重启即可使配置生效</p>
<p>如 token时长 验证次数等等 需要修改 </p>
<ol>
<li>nacos中要有一个与微服务名有关的配置文件</li>
<li>微服务中要以特定的方式读取需要热更新的配置属性</li>
<li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\86186\AppData\Roaming\Typora\typora-user-images\image-20240729184553673.png" alt="image-20240729184553673"></li>
<li>推荐使用第一种 添加@Bean注解</li>
</ol>
<h4 id="动态路由"><a href="#动态路由" class="headerlink" title="动态路由"></a>动态路由</h4><h2 id="微服务保护和分布式事务"><a href="#微服务保护和分布式事务" class="headerlink" title="微服务保护和分布式事务"></a>微服务保护和分布式事务</h2><h3 id="雪崩问题"><a href="#雪崩问题" class="headerlink" title="雪崩问题"></a>雪崩问题</h3><p>微服务调用链路中的某个服务故障 引起整个链路中的所有微服务都不用</p>
<ul>
<li><strong>请求限流</strong> 限制微服务的请求的并发量</li>
</ul>
<p> 即qbs</p>
<ul>
<li><strong>线程隔离</strong>  限定每个业务能使用的线程数量而将故障业务隔离 避免一个业务将整个服务阻塞</li>
</ul>
<p>调节并发线程数 （5个并发线程 如果单线程qps为2 那么5线程的qps为10）</p>
<ul>
<li><strong>服务熔断</strong> 断路器统计请求的异常比例或慢调用比例 如果超出与之则会熔断该业务 拦截该接口的请求 所有请求快速失败 全都走fallback 逻辑</li>
</ul>
<p>将feignclient作为sentinel的簇点资源  配置文件开启 <code>feignclient.sentinel.enable:true</code></p>
<p>feignclient的fallback配置有两种方式 </p>
<ol>
<li>fallbackclass 无法对远程调用的异常做处理</li>
<li>fallbackfactory 可以对远程调用的异常做处理 <ul>
<li>自定义fallbackfactory <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\86186\AppData\Roaming\Typora\typora-user-images\image-20240730160001049.png" alt="image-20240730160001049"></li>
</ul>
</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\86186\AppData\Roaming\Typora\typora-user-images\image-20240730160108903.png" alt="image-20240730160108903"></p>
<ul>
<li><strong>失败处理</strong> 定义fallback逻辑 让业务失败时不再抛出异常 而是返回默认数据或友好提示</li>
</ul>
<h3 id="Sentinel"><a href="#Sentinel" class="headerlink" title="Sentinel"></a>Sentinel</h3><p>阿里巴巴开源的一款微服务流量控制组件</p>
<h2 id="分布式事务"><a href="#分布式事务" class="headerlink" title="分布式事务"></a>分布式事务</h2><h3 id="Seata"><a href="#Seata" class="headerlink" title="Seata"></a>Seata</h3><p>阿里巴巴和蚂蚁金服 共同设计的分布式事务的解决方案</p>
<ul>
<li>TC（transaction coordinator）事务协调者 维护全局和分支事务的状态 协调全局事务提交或回滚</li>
<li>TM （transaction manage) 事务管理器 定义全局事务的范围 开启全局事务 提交或回滚全局事务</li>
<li>RM（resource manager）资源管理器 管理分支事务 与TC交谈以注册分支事务和报告分支事务的状态</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\86186\AppData\Roaming\Typora\typora-user-images\image-20240730163932495.png" alt="image-20240730163932495"></p>
<h2 id="RabbitMQ"><a href="#RabbitMQ" class="headerlink" title="RabbitMQ"></a>RabbitMQ</h2><p>高性能异步通讯组件</p>
<h3 id="同步调用"><a href="#同步调用" class="headerlink" title="同步调用"></a>同步调用</h3><ul>
<li>时效性强 等待到结果才返回</li>
<li>扩展性差 性能下降 级联失败</li>
</ul>
<h3 id="异步调用"><a href="#异步调用" class="headerlink" title="异步调用"></a>异步调用</h3><ul>
<li>解除耦合 扩展性强 无需等待 性能好 </li>
<li>故障隔离  下游服务故障不影响上游业务</li>
<li>缓存消息 流量削峰填补</li>
<li>不会得到结果 时效性差 业务安全依赖broker的可靠性</li>
</ul>
<h3 id="MQ技术选型"><a href="#MQ技术选型" class="headerlink" title="MQ技术选型"></a>MQ技术选型</h3><ul>
<li>RabbitMQ</li>
<li>ActiveMQ</li>
<li>RocketMQ</li>
<li>Kafka</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\86186\AppData\Roaming\Typora\typora-user-images\image-20240726101452651.png" alt="image-20240726101452651"></p>
<p>虚拟主机  数据隔离</p>
<h3 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h3><p>基于AMQP Spring AMQP 操作rabbitMQ</p>
<ul>
<li>引入 Spring boot starter amqp依赖</li>
<li>配置yml 文件 添加 rabbitmq配置 host port virtual-host username password</li>
<li>注入 RabbitTemplate  调用api 发消息</li>
<li>添加注释 @RabbitListener 传入监听队列名称   方法参数存储接收的消息（spring自动进行消息与参数对象的转换）</li>
</ul>
<h3 id="Work-Queues"><a href="#Work-Queues" class="headerlink" title="Work Queues"></a>Work Queues</h3><p>任务模型 让多个消费者绑定到一个队列 共同消费队列中的消息</p>
<p><strong>消费者消息推送限制</strong></p>
<p>默认情况下 RabbitMQ会将消息依次轮询投递给绑定在队列上的消费者 但是这并没有考虑消费者是否已经处理完消息 可能会出现消费堆积 所以修改yml配置文件 设置preFetch为1 确保统一时刻最多投递给消费者1条消息</p>
<p>work<strong>模型的使用</strong></p>
<ul>
<li>多个消费者绑定到一个队列 可以加快消息处理速度</li>
<li>同一条消息只会被一个消费者处理</li>
<li>通过设置prefetch来控制消费者预取的消息数量 处理完一条在处理下一条 实现能者多劳</li>
</ul>
<h3 id="交换机"><a href="#交换机" class="headerlink" title="交换机"></a>交换机</h3><p>接收publisher发送的消息 将消息按照规则路由到与之绑定的队列</p>
<ul>
<li><p>Fanout 广播  将消息发送给所有队列</p>
</li>
<li><p>Direct 定向  将收到消息按照规则路由到指定的Queue</p>
<ul>
<li>每个Queue斗鱼Exchange设置一个BindingKey</li>
<li>发布者发送消息时 指定消息的RoutingKey</li>
<li>Exchange 将消息路由到BindingKey与消息RoutingKey一致的队列</li>
</ul>
</li>
<li><p>Topic 话题</p>
<ul>
<li>基于RoutingKey做消息路由 但是routingKey通常是多个单词的组合并且是以 <code>.</code> 分隔</li>
<li>Queue与Exchange指定BindingKey可以使用通配符  <code>#</code>代指0个或多个单词 <code>*</code>代指一个单词</li>
</ul>
</li>
</ul>
<h3 id="声明队列交换机"><a href="#声明队列交换机" class="headerlink" title="声明队列交换机"></a>声明队列交换机</h3><p>SpringAMQP提供了几个类 同于声明 队列 交换机 及其绑定关系</p>
<ul>
<li><p>Queue 声明队列  QueueBuilder</p>
</li>
<li><p>Exchange 声明交换机 ExchangeBuilder</p>
</li>
<li><p>Binding 声明交换机和队列的绑定关系 使用工厂类BindingBuilder构建</p>
</li>
</ul>
<p><strong>案例</strong></p>
<p>改造余额支付功能 不再同步调用支付服务的openfegin接口 而是采用异步MQ通知交易服务更新订单状态</p>
<p>一些边缘业务适合使用mq处理 更新订单状态 短信通知用户 增加用户积分</p>
<h2 id="RabbitMQ高级"><a href="#RabbitMQ高级" class="headerlink" title="RabbitMQ高级"></a>RabbitMQ高级</h2><p>消息可靠性问题 	·</p>
<h3 id="发送者可靠性"><a href="#发送者可靠性" class="headerlink" title="发送者可靠性"></a>发送者可靠性</h3><ul>
<li>发送者重连<ul>
<li>由于网络波动 可能会出现发送者发送MQ失败的情况 通过配置可以开启连接失败后的重连机制</li>
<li>但是SpringAMQP重连机制是阻塞式的重试 多次重连等待过程中 当前线程是被阻塞的 影响业务性能</li>
<li>对于有业务性能需求 建议禁用重试机制  当然也可以考虑使用异步线程来执行发送消息的代码</li>
</ul>
</li>
<li>发送者确认机制<ul>
<li>SpringAMQP提供了PublisherConfim和PublisherReturn两种确认机制 开启后 当发送者发送消息给MQ后 MQ会返回结果给发送者</li>
<li>消息投递到MQ 但是路由失败 返回 ACK</li>
<li>临时消息投递到MQ 并且入队成功 返回ACK</li>
<li>持久消息投递到MQ 并且入队完成持久化 返回ACK</li>
<li>其他情况返回NACK 告知投递失败</li>
<li>开启机制三种模式<ul>
<li>none 关闭</li>
<li>simple 同步阻塞等待MQ回执</li>
<li>correlated MQ异步回调方式返回回执消息</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="MQ可靠性"><a href="#MQ可靠性" class="headerlink" title="MQ可靠性"></a>MQ可靠性</h3><p>默认情况MQ会把消息存储在内存降低消息收发的延迟</p>
<p>一旦MQ宕机 内存中的消息会丢失  并且内存空间有限 当消费者故障或者处理过慢 会导致消息挤压</p>
<p><strong>开启数据持久化</strong> 会存入磁盘 但是会导致性能下降 无法应对高并发</p>
<h4 id="LazyQueue-惰性队列"><a href="#LazyQueue-惰性队列" class="headerlink" title="LazyQueue 惰性队列"></a>LazyQueue 惰性队列</h4><p>接收消息后直接存入磁盘不再存入内存 消费者要消费时才会从磁盘中读取并加载到内存（可以提前缓存部分消息到内存 最多2048条）</p>
<p>在3.12版本后 所有队列都是LazyQUeue模式无法更改</p>
<h3 id="消费者可靠性"><a href="#消费者可靠性" class="headerlink" title="消费者可靠性"></a>消费者可靠性</h3><h4 id="消费者确认机制"><a href="#消费者确认机制" class="headerlink" title="消费者确认机制"></a>消费者确认机制</h4><p>当消费者处理消息结束后 向MQ发送一个回执 告知MQ自己消息处理的状态</p>
<ul>
<li>ack 成功处理消息 MQ从队列中删除消息</li>
<li>nack  消息处理失败 MQ再次投递消息</li>
<li>reject 消息处理失败并拒绝该消息 MQ从队列中删除该消息</li>
</ul>
<p>springAMQP实现了消息确认机制 配置文件开启</p>
<ul>
<li>none 不处理 消息投递之后立刻ack 消息从mq中删除</li>
<li>manual 手动模式 需要自己在业务代码中调用api 发送ack或者reject 存在业务入侵 但灵活</li>
<li>auto 自动模式 SpringAMQP利用AOP对消息处理逻辑做了环绕增强 当业务正常时自动返回ack<ul>
<li>业务异常 自定返回nack</li>
<li>消息处理或校验异常 返回reject</li>
</ul>
</li>
</ul>
<h4 id="消费者失败重试机制"><a href="#消费者失败重试机制" class="headerlink" title="消费者失败重试机制"></a>消费者失败重试机制</h4><p>配置文件开启重试机制 如果重试次数达到上限 则需要MessagesRecoverer接口来处理 包含三种不同的实现：</p>
<ul>
<li>RejectAndDontRequeueRecoverer 重试次数耗尽后 直接reject 丢弃消息 默认该方法</li>
<li>ImmediateRequeueMessageRecoverer 重试次数耗尽后 返回nack 消息重新入队</li>
<li>RepublishMessageRecoverer 重试后 将失败的消息投递到指定的交换机</li>
</ul>
<h4 id="业务幂等性"><a href="#业务幂等性" class="headerlink" title="业务幂等性"></a>业务幂等性</h4><p><code>f(f(x))=f(x)</code>在程序开发中 指同一个业务 执行一次或多次对业务的状态的影响是一致的</p>
<h5 id="唯一消息id"><a href="#唯一消息id" class="headerlink" title="唯一消息id"></a>唯一消息id</h5><h6 id="给每个消息都设置一个唯一id-liyongid区分是否是重复消息"><a href="#给每个消息都设置一个唯一id-liyongid区分是否是重复消息" class="headerlink" title="给每个消息都设置一个唯一id liyongid区分是否是重复消息"></a>给每个消息都设置一个唯一id liyongid区分是否是重复消息</h6><ol>
<li>每一条消息都生成一个唯一的id 与消息一起投递给消费者</li>
<li>消费者接收后处理自己的业务 业务处理成功后将消息id存入数据库</li>
<li>下次收到同样的消息 数据库查询是否存在</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\86186\AppData\Roaming\Typora\typora-user-images\image-20240807143141817.png" alt="image-20240807143141817"></p>
<h5 id="业务判断"><a href="#业务判断" class="headerlink" title="业务判断"></a>业务判断</h5><h6 id="结合业务逻辑-基于业务本身做判断"><a href="#结合业务逻辑-基于业务本身做判断" class="headerlink" title="结合业务逻辑 基于业务本身做判断"></a>结合业务逻辑 基于业务本身做判断</h6><p>面试题：如何确保支付服务和交易服务之间的订单状态一致性</p>
<ul>
<li>首先支付服务会在用户支付成功后利用MQ通知交易服务 完成订单状态同步</li>
<li>其次 为了保证MQ消息可靠性 我们采用生产者确认机制 消费者确认 消费者失败重试等策略 确保消息投递和处理的可靠性 同时也开启了MQ的持久化 避免因为服务宕机导致消息丢失</li>
<li>左后我们还在交易服务更新订单状态时做了业务幂等判断 避免因为重复消息导致订单状态异常</li>
</ul>
<h3 id="延迟消息"><a href="#延迟消息" class="headerlink" title="延迟消息"></a>延迟消息</h3><p>在网络异常等特殊情况</p>
<p>发送者发送消息指定一个时间 消费者不会立刻收到消息 而是在指定时间后才收到消息</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\86186\AppData\Roaming\Typora\typora-user-images\image-20240807144837853.png" alt="image-20240807144837853"></p>
<h4 id="死信交换机"><a href="#死信交换机" class="headerlink" title="死信交换机"></a>死信交换机</h4><p>死信：</p>
<ul>
<li>消费者使用reject或者nack声明消费失败 并且消费的requere参数设置为false</li>
<li>消息是一个过期消息（达到了队列或消息本身设置的过期时间）超时无人消费</li>
<li>要投递的队列消息堆积满了 最早的消息可能成为死信</li>
</ul>
<p>如果队列通过dead-letter-exchange 属性制定了一个交换机 那么该队列中的死信就会投递到这个交换机中 这个交换机成为死信交换机 </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="C:\Users\86186\AppData\Roaming\Typora\typora-user-images\image-20240807195123756.png" alt="image-20240807195123756"></p>
<h4 id="延迟消息插件"><a href="#延迟消息插件" class="headerlink" title="延迟消息插件"></a>延迟消息插件</h4><p>将普通交换机改为支持延迟消息功能的交换机 当消息投递到交换机可以暂存一定时间 到期后再投递到队列</p>
<h4 id="取消超时订单"><a href="#取消超时订单" class="headerlink" title="取消超时订单"></a>取消超时订单</h4><h2 id="Elasticsearch"><a href="#Elasticsearch" class="headerlink" title="Elasticsearch"></a>Elasticsearch</h2></article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/images/touxiang.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/images/touxiang.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">Acting</div><div class="post-copyright__author_desc"></div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://example.com/2023/12/30/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://example.com/2023/12/30/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84/')">微服务</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display: none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://example.com/2023/12/30/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=微服务&amp;url=http://example.com/2023/12/30/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84/&amp;pic=" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/java/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>java<span class="tagsPageCount">6</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="/images/touxiang.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/12/20/MybatisPlus/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">MybatisPlus框架</div></div></a></div><div class="next-post pull-right"><a href="/2023/12/30/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">网络编程</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2023/12/20/MybatisPlus/" title="MybatisPlus框架"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-12-20</div><div class="title">MybatisPlus框架</div></div></a></div><div><a href="/2023/12/30/MySql%E9%AB%98%E7%BA%A7/" title="Mysql高级"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-12-30</div><div class="title">Mysql高级</div></div></a></div><div><a href="/2023/12/06/MySQL/" title="Mysql基础"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-12-06</div><div class="title">Mysql基础</div></div></a></div><div><a href="/2023/12/15/SpringMVC%E5%AD%A6%E4%B9%A0/" title="springboot"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-12-15</div><div class="title">springboot</div></div></a></div><div><a href="/2023/12/30/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" title="网络编程"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-12-30</div><div class="title">网络编程</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/images/touxiang.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__description"></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">Acting</h1><div class="author-info__desc"></div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/ActingGH" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/372204786" target="_blank" title="BiliBili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="card-widget anzhiyu-right-widget" id="card-wechat" onclick="null"><div id="flip-wrapper"><div id="flip-content"><div class="face" style="background: url(https://bu.dusays.com/2023/01/13/63c02edf44033.png) center center / 100% no-repeat"></div><div class="back face" style="background: url(https://bu.dusays.com/2023/05/13/645fa415e8694.png) center center / 100% no-repeat"></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.</span> <span class="toc-text">微服务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringCloud"><span class="toc-number">1.1.</span> <span class="toc-text">SpringCloud</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86"><span class="toc-number">1.2.</span> <span class="toc-text">服务治理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Nacos"><span class="toc-number">1.2.1.</span> <span class="toc-text">Nacos</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OpenFegin"><span class="toc-number">1.2.2.</span> <span class="toc-text">OpenFegin</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E6%B1%A0"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">连接池</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">最佳实践</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E8%BE%93%E5%87%BA"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">日志输出</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E5%85%B3"><span class="toc-number">1.3.</span> <span class="toc-text">网关</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E5%85%B3%E8%B7%AF%E7%94%B1"><span class="toc-number">1.3.1.</span> <span class="toc-text">网关路由</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">1.3.2.</span> <span class="toc-text">自定义过滤器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E7%9A%84%E4%BC%A0%E9%80%92"><span class="toc-number">1.3.3.</span> <span class="toc-text">用户信息的传递</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BD%91%E5%85%B3%E4%BC%A0%E9%80%92%E5%88%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">网关传递到微服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B9%8B%E9%97%B4%E4%BC%A0%E9%80%92%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">微服务之间传递用户信息</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86"><span class="toc-number">1.4.</span> <span class="toc-text">配置管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#nacos-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.4.1.</span> <span class="toc-text">nacos 配置管理服务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%85%B1%E4%BA%AB"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">配置共享</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%83%AD%E6%9B%B4%E6%96%B0"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">配置热更新</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E8%B7%AF%E7%94%B1"><span class="toc-number">1.4.1.3.</span> <span class="toc-text">动态路由</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4%E5%92%8C%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="toc-number">1.5.</span> <span class="toc-text">微服务保护和分布式事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%AA%E5%B4%A9%E9%97%AE%E9%A2%98"><span class="toc-number">1.5.1.</span> <span class="toc-text">雪崩问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sentinel"><span class="toc-number">1.5.2.</span> <span class="toc-text">Sentinel</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="toc-number">1.6.</span> <span class="toc-text">分布式事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Seata"><span class="toc-number">1.6.1.</span> <span class="toc-text">Seata</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RabbitMQ"><span class="toc-number">1.7.</span> <span class="toc-text">RabbitMQ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E8%B0%83%E7%94%A8"><span class="toc-number">1.7.1.</span> <span class="toc-text">同步调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E8%B0%83%E7%94%A8"><span class="toc-number">1.7.2.</span> <span class="toc-text">异步调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MQ%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B"><span class="toc-number">1.7.3.</span> <span class="toc-text">MQ技术选型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C"><span class="toc-number">1.7.4.</span> <span class="toc-text">操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Work-Queues"><span class="toc-number">1.7.5.</span> <span class="toc-text">Work Queues</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%A4%E6%8D%A2%E6%9C%BA"><span class="toc-number">1.7.6.</span> <span class="toc-text">交换机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A3%B0%E6%98%8E%E9%98%9F%E5%88%97%E4%BA%A4%E6%8D%A2%E6%9C%BA"><span class="toc-number">1.7.7.</span> <span class="toc-text">声明队列交换机</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RabbitMQ%E9%AB%98%E7%BA%A7"><span class="toc-number">1.8.</span> <span class="toc-text">RabbitMQ高级</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E8%80%85%E5%8F%AF%E9%9D%A0%E6%80%A7"><span class="toc-number">1.8.1.</span> <span class="toc-text">发送者可靠性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MQ%E5%8F%AF%E9%9D%A0%E6%80%A7"><span class="toc-number">1.8.2.</span> <span class="toc-text">MQ可靠性</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#LazyQueue-%E6%83%B0%E6%80%A7%E9%98%9F%E5%88%97"><span class="toc-number">1.8.2.1.</span> <span class="toc-text">LazyQueue 惰性队列</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85%E5%8F%AF%E9%9D%A0%E6%80%A7"><span class="toc-number">1.8.3.</span> <span class="toc-text">消费者可靠性</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85%E7%A1%AE%E8%AE%A4%E6%9C%BA%E5%88%B6"><span class="toc-number">1.8.3.1.</span> <span class="toc-text">消费者确认机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85%E5%A4%B1%E8%B4%A5%E9%87%8D%E8%AF%95%E6%9C%BA%E5%88%B6"><span class="toc-number">1.8.3.2.</span> <span class="toc-text">消费者失败重试机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E5%B9%82%E7%AD%89%E6%80%A7"><span class="toc-number">1.8.3.3.</span> <span class="toc-text">业务幂等性</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%94%AF%E4%B8%80%E6%B6%88%E6%81%AFid"><span class="toc-number">1.8.3.3.1.</span> <span class="toc-text">唯一消息id</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%BB%99%E6%AF%8F%E4%B8%AA%E6%B6%88%E6%81%AF%E9%83%BD%E8%AE%BE%E7%BD%AE%E4%B8%80%E4%B8%AA%E5%94%AF%E4%B8%80id-liyongid%E5%8C%BA%E5%88%86%E6%98%AF%E5%90%A6%E6%98%AF%E9%87%8D%E5%A4%8D%E6%B6%88%E6%81%AF"><span class="toc-number">1.8.3.3.1.1.</span> <span class="toc-text">给每个消息都设置一个唯一id liyongid区分是否是重复消息</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E5%88%A4%E6%96%AD"><span class="toc-number">1.8.3.3.2.</span> <span class="toc-text">业务判断</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%BB%93%E5%90%88%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91-%E5%9F%BA%E4%BA%8E%E4%B8%9A%E5%8A%A1%E6%9C%AC%E8%BA%AB%E5%81%9A%E5%88%A4%E6%96%AD"><span class="toc-number">1.8.3.3.2.1.</span> <span class="toc-text">结合业务逻辑 基于业务本身做判断</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF"><span class="toc-number">1.8.4.</span> <span class="toc-text">延迟消息</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%BB%E4%BF%A1%E4%BA%A4%E6%8D%A2%E6%9C%BA"><span class="toc-number">1.8.4.1.</span> <span class="toc-text">死信交换机</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E6%8F%92%E4%BB%B6"><span class="toc-number">1.8.4.2.</span> <span class="toc-text">延迟消息插件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%96%E6%B6%88%E8%B6%85%E6%97%B6%E8%AE%A2%E5%8D%95"><span class="toc-number">1.8.4.3.</span> <span class="toc-text">取消超时订单</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Elasticsearch"><span class="toc-number">1.9.</span> <span class="toc-text">Elasticsearch</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/12/30/Docker%E5%AD%A6%E4%B9%A0/" title="docker基础">docker基础</a><time datetime="2023-12-30T08:34:20.000Z" title="Created 2023-12-30 16:34:20">2023-12-30</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/12/30/Linux%E5%AD%A6%E4%B9%A0/" title="Linux基础入门">Linux基础入门</a><time datetime="2023-12-30T08:34:20.000Z" title="Created 2023-12-30 16:34:20">2023-12-30</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/12/30/MySql%E9%AB%98%E7%BA%A7/" title="Mysql高级">Mysql高级</a><time datetime="2023-12-30T08:34:20.000Z" title="Created 2023-12-30 16:34:20">2023-12-30</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/12/30/git%E5%AD%A6%E4%B9%A0/" title="git基础操作">git基础操作</a><time datetime="2023-12-30T08:34:20.000Z" title="Created 2023-12-30 16:34:20">2023-12-30</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/12/30/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" title="网络编程">网络编程</a><time datetime="2023-12-30T08:34:20.000Z" title="Created 2023-12-30 16:34:20">2023-12-30</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2024 By <a class="footer-bar-link" href="/" title="Acting" target="_blank">Acting</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/ActingGH" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">Articles</div><div class="length-num">9</div></a><a href="/tags/" title="tag"><div class="headline">Tags</div><div class="length-num">9</div></a><a href="/categories/" title="category"><div class="headline">Categories</div><div class="length-num">1</div></a></div><span class="sidebar-menu-item-title">Function</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="Display Mode"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>Display Mode</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="安知鱼图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="安知鱼图床"/><span class="back-menu-item-text">安知鱼图床</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/Linux/" style="font-size: 0.88rem;">Linux<sup>1</sup></a><a href="/tags/TCP/" style="font-size: 0.88rem;">TCP<sup>1</sup></a><a href="/tags/UDP/" style="font-size: 0.88rem;">UDP<sup>1</sup></a><a href="/tags/docker/" style="font-size: 0.88rem;">docker<sup>1</sup></a><a href="/tags/git/" style="font-size: 0.88rem;">git<sup>1</sup></a><a href="/tags/java/" style="font-size: 0.88rem;">java<sup>6</sup></a><a href="/tags/mysql/" style="font-size: 0.88rem;">mysql<sup>3</sup></a><a href="/tags/springMVC/" style="font-size: 0.88rem;">springMVC<sup>1</sup></a><a href="/tags/springboot/" style="font-size: 0.88rem;">springboot<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="Switch Between Traditional Chinese And Simplified Chinese">繁</button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Setting"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 Acting 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><div class="js-pjax"><input type="hidden" name="page-type" id="page-type" value="post"></div><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>